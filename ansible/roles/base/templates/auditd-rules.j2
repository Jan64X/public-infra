# ANSSI-BP-028 Audit Rules
# ansible_managed

# Remove any existing rules
-D

# Buffer Size
-b 8192

# Failure Mode (1 = printk, 2 = panic on failure for critical systems)
-f 1

# Audit system calls
-a always,exit -F arch=b64 -S execve -k exec
-a always,exit -F arch=b32 -S execve -k exec

# Monitor authentication
-w /var/log/auth.log -p wa -k auth
-w /var/log/faillog -p wa -k auth
-w /var/log/lastlog -p wa -k auth
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/gshadow -p wa -k identity

# Monitor sudo
-w /etc/sudoers -p wa -k sudoers
-w /etc/sudoers.d/ -p wa -k sudoers

# Monitor SSH
-w /etc/ssh/sshd_config -p wa -k sshd

# Monitor network configuration
-a always,exit -F arch=b64 -S sethostname,setdomainname -k network
-w /etc/network/ -p wa -k network

# Monitor file deletions
# Note: unlink and rename syscalls don't exist on arm64, only unlinkat/renameat
{% if ansible_facts['architecture'] == 'x86_64' %}
-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=-1 -k delete
{% else %}
-a always,exit -F arch=b64 -S unlinkat,renameat -F auid>=1000 -F auid!=-1 -k delete
{% endif %}

# Monitor privilege escalation
-a always,exit -F arch=b64 -S setuid,setgid,setreuid,setregid -k privilege_escalation

# Monitor kernel modules
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b64 -S init_module,delete_module -k modules

# Make configuration immutable (set to 2 to prevent changes until reboot)
-e 1
