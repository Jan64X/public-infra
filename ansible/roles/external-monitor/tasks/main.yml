---
# =============================================================================
# EXTERNAL MONITOR - Prometheus + Loki + Grafana via Podman Quadlet
# =============================================================================

# =============================================================================
# PODMAN INSTALLATION
# =============================================================================

- name: Install Podman
  ansible.builtin.apt:
    name:
      - podman
      - uidmap
      - slirp4netns
    state: present
    update_cache: true
  become: true

- name: Ensure Quadlet directory exists
  ansible.builtin.file:
    path: /etc/containers/systemd
    state: directory
    mode: '0755'
  become: true

# =============================================================================
# DIRECTORY STRUCTURE
# =============================================================================

- name: Create external-monitor directories
  ansible.builtin.file:
    path: "{{ directory_item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/external-monitor
    - /etc/external-monitor/prometheus
    - /etc/external-monitor/loki
    - /etc/external-monitor/grafana
    - /etc/external-monitor/grafana/provisioning
    - /etc/external-monitor/grafana/provisioning/datasources
    - /etc/external-monitor/grafana/provisioning/dashboards
    - /var/lib/external-prometheus
    - /var/lib/external-grafana
    - /var/lib/external-loki
  loop_control:
    loop_var: directory_item
  become: true

- name: Set ownership for Prometheus directory
  ansible.builtin.file:
    path: /var/lib/external-prometheus
    state: directory
    owner: 65534
    group: 65534
    recurse: true
  become: true

- name: Set ownership for Grafana directory
  ansible.builtin.file:
    path: /var/lib/external-grafana
    state: directory
    owner: 472
    group: 472
    recurse: true
  become: true

- name: Set ownership for Loki directory
  ansible.builtin.file:
    path: /var/lib/external-loki
    state: directory
    owner: 10001
    group: 10001
    recurse: true
  become: true

# =============================================================================
# CONFIGURATION
# =============================================================================

- name: Configure Prometheus for external monitoring
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /etc/external-monitor/prometheus/prometheus.yml
    mode: '0644'
  become: true
  register: prometheus_config
  notify: Restart external monitor stack

- name: Seed empty Prometheus alert rules
  ansible.builtin.copy:
    content: "groups: []\n"
    dest: /etc/external-monitor/prometheus/alert_rules.yml
    mode: '0644'
    force: false
  become: true

- name: Configure Loki
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: /etc/external-monitor/loki/loki-config.yml
    mode: '0644'
  become: true
  notify: Restart external monitor stack

- name: Configure Grafana datasources
  ansible.builtin.template:
    src: grafana-datasources.yml.j2
    dest: /etc/external-monitor/grafana/provisioning/datasources/datasources.yml
    mode: '0644'
  become: true
  notify: Restart external monitor stack

- name: Configure Grafana dashboard provisioning
  ansible.builtin.template:
    src: grafana-dashboard-provider.yml.j2
    dest: /etc/external-monitor/grafana/provisioning/dashboards/default.yml
    mode: '0644'
  become: true
  notify: Restart external monitor stack

# =============================================================================
# PODMAN QUADLET
# =============================================================================

- name: Deploy external-monitor network Quadlet
  ansible.builtin.template:
    src: external-monitor.network.j2
    dest: /etc/containers/systemd/external-monitor.network
    mode: '0644'
  become: true

- name: Deploy Loki container Quadlet
  ansible.builtin.template:
    src: external-loki.container.j2
    dest: /etc/containers/systemd/external-loki.container
    mode: '0644'
  become: true
  notify: Restart external monitor stack

- name: Deploy Prometheus container Quadlet
  ansible.builtin.template:
    src: external-prometheus.container.j2
    dest: /etc/containers/systemd/external-prometheus.container
    mode: '0644'
  become: true
  notify: Restart external monitor stack

- name: Deploy Grafana container Quadlet
  ansible.builtin.template:
    src: external-grafana.container.j2
    dest: /etc/containers/systemd/external-grafana.container
    mode: '0644'
  become: true
  notify: Restart external monitor stack

- name: Reload systemd to pick up Quadlet units
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Check if monitoring images exist locally
  ansible.builtin.command:
    cmd: "podman image exists {{ image_item }}"
  loop:
    - docker.io/grafana/loki:latest
    - docker.io/prom/prometheus:latest
    - docker.io/grafana/grafana:latest
  loop_control:
    loop_var: image_item
  register: monitor_images_check
  changed_when: false
  failed_when: false
  become: true

- name: Pull missing monitoring stack images
  ansible.builtin.command:
    cmd: "podman pull {{ item.image_item }}"
  loop: "{{ monitor_images_check.results }}"
  when: item.rc != 0
  changed_when: true
  become: true

- name: Start Loki service
  ansible.builtin.systemd:
    name: external-loki
    state: started
    enabled: true
  become: true

- name: Start Prometheus service
  ansible.builtin.systemd:
    name: external-prometheus
    state: started
    enabled: true
  become: true

- name: Start Grafana service
  ansible.builtin.systemd:
    name: external-grafana
    state: started
    enabled: true
  become: true

# =============================================================================
# FIREWALL
# =============================================================================

- name: Allow Prometheus HTTP (localhost only)
  community.general.ufw:
    rule: allow
    port: 9090
    proto: tcp
    from_ip: 127.0.0.1
  notify: Reload ufw

- name: Remove stale Alertmanager UFW rule
  community.general.ufw:
    rule: allow
    port: 9093
    proto: tcp
    from_ip: 127.0.0.1
    delete: true
  notify: Reload ufw

# --- Clean up stale Docker-era artefacts ---

- name: Remove stale docker-compose.yml
  ansible.builtin.file:
    path: /etc/external-monitor/docker-compose.yml
    state: absent
