---
# =============================================================================
# SEARXNG - Privacy Search Engine via Podman Quadlet
# =============================================================================

# =============================================================================
# PODMAN INSTALLATION
# =============================================================================

- name: Install Podman
  ansible.builtin.apt:
    name:
      - podman
      - uidmap
      - slirp4netns
    state: present
    update_cache: true
  become: true

- name: Ensure Quadlet directory exists
  ansible.builtin.file:
    path: /etc/containers/systemd
    state: directory
    mode: '0755'
  become: true

# =============================================================================
# SEARXNG CONFIGURATION
# =============================================================================

- name: Create SearXNG directories
  ansible.builtin.file:
    path: "{{ directory_item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/searxng
    - /etc/searxng/custom
    - /etc/searxng/custom/simple
    - /etc/searxng/custom/simple/img
  loop_control:
    loop_var: directory_item
  become: true

- name: Check if SearXNG container exists
  ansible.builtin.command:
    cmd: podman container exists searxng
  register: searxng_container
  changed_when: false
  failed_when: false
  become: true

- name: Create credentials directory if it doesn't exist
  ansible.builtin.file:
    path: "{{ playbook_dir }}/credentials/hosts/{{ inventory_hostname }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  become: false

- name: Generate SearXNG secret key
  ansible.builtin.set_fact:
    searxng_secret_key: "{{ lookup('ansible.builtin.password',
                            playbook_dir + '/credentials/hosts/' + inventory_hostname + '/searxng_secret_key.txt' +
                            ' chars=ascii_letters,digits length=64') }}"

- name: Configure SearXNG settings
  ansible.builtin.template:
    src: settings.yml.j2
    dest: /etc/searxng/settings.yml
    mode: '0644'
  become: true
  register: searxng_settings_result

- name: Copy SearXNG logo
  ansible.builtin.copy:
    src: searxng.png
    dest: /etc/searxng/custom/simple/img/searxng.png
    mode: '0644'
  become: true
  register: searxng_logo_result

# =============================================================================
# PODMAN QUADLET
# =============================================================================

- name: Deploy SearXNG container Quadlet
  ansible.builtin.template:
    src: searxng.container.j2
    dest: /etc/containers/systemd/searxng.container
    mode: '0644'
  become: true
  register: searxng_quadlet_result

- name: Reload systemd to pick up Quadlet units
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Check if SearXNG image exists locally
  ansible.builtin.command:
    cmd: podman image exists docker.io/searxng/searxng:latest
  register: searxng_image_check
  changed_when: false
  failed_when: false
  become: true

- name: Pull SearXNG image
  ansible.builtin.command:
    cmd: podman pull docker.io/searxng/searxng:latest
  when: searxng_image_check.rc != 0
  changed_when: true
  become: true

- name: Start SearXNG service
  ansible.builtin.systemd:
    name: searxng
    state: started
    enabled: true
  become: true
  when: >-
    searxng_settings_result.changed or
    searxng_quadlet_result.changed or
    searxng_logo_result.changed or
    searxng_container.rc != 0

- name: Restart SearXNG if config changed
  ansible.builtin.systemd:
    name: searxng
    state: restarted
  become: true
  when: >-
    (searxng_settings_result.changed or
    searxng_quadlet_result.changed or
    searxng_logo_result.changed) and
    searxng_container.rc == 0

# --- Clean up stale Docker-era artefacts ---

- name: Remove stale docker-compose.yml
  ansible.builtin.file:
    path: /etc/searxng/docker-compose.yml
    state: absent

# Firewall: no host ports exposed â€” traffic comes via vps-services Podman network
